name: Deploy Trading System (Docker)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install sshpass and rsync
        run: sudo apt-get update && sudo apt-get install -y sshpass rsync

      - name: Deploy to Server
        env:
          SSH_HOST: ${{ secrets.ALIYUN_SSH_HOST }}
          SSH_USERNAME: ${{ secrets.ALIYUN_USER_USER }}
          SSH_PASSWORD: ${{ secrets.ALIYUN_SSH_PASSWORD }}
          SSH_PORT: ${{ secrets.ALIYUN_SSH_PORT || '22' }}
          DEPLOY_PATH: ${{ secrets.ALIYUN_DEPLOY_PATH || '/opt/nof1-trading' }}
        run: |
          # 1. åŒæ­¥æ–‡ä»¶ (æ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶)
          sshpass -p "$SSH_PASSWORD" rsync -avz --delete \
            -e "ssh -p $SSH_PORT -o StrictHostKeyChecking=no" \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='logs/' \
            --exclude='.env' \
            --exclude='.env.production' \
            --exclude='.voltagent' \
            --exclude='voltagent-data' \
            ./ $SSH_USERNAME@$SSH_HOST:$DEPLOY_PATH/

          # 2. è¿œç¨‹æ‰§è¡Œéƒ¨ç½²å‘½ä»¤
          sshpass -p "$SSH_PASSWORD" ssh -p $SSH_PORT -o StrictHostKeyChecking=no $SSH_USERNAME@$SSH_HOST << EOF
            cd $DEPLOY_PATH

            # æ£€æµ‹å¯ç”¨çš„ Docker Compose å‘½ä»¤
            DOCKER_COMPOSE_CMD=""
            if docker compose version &> /dev/null; then
                DOCKER_COMPOSE_CMD="docker compose"
            elif command -v docker-compose &> /dev/null; then
                DOCKER_COMPOSE_CMD="docker-compose"
            else
                echo "âŒ Error: Neither 'docker compose' nor 'docker-compose' found."
                echo "Please install Docker Compose plugin or docker-compose standalone."
                exit 1
            fi
            echo "âœ… Using command: \$DOCKER_COMPOSE_CMD"

            # ç¡®ä¿æ•°æ®ç›®å½•å­˜åœ¨
            mkdir -p voltagent-data logs

            echo "ğŸš€ Starting Docker Compose deployment..."
            
            # 1. æ˜¾å¼æ„å»ºé•œåƒï¼Œç¡®ä¿æ„å»ºæˆåŠŸ
            echo "Building image..."
            if ! \$DOCKER_COMPOSE_CMD -f docker-compose.prod.yml build; then
                echo "âŒ build failed"
                exit 1
            fi

            # 2. åœæ­¢å¹¶ç§»é™¤æ—§å®¹å™¨ï¼ˆé˜²æ­¢ç«¯å£å†²çªæˆ–çŠ¶æ€æ®‹ç•™ï¼‰
            \$DOCKER_COMPOSE_CMD -f docker-compose.prod.yml down --remove-orphans

            # 3. å¯åŠ¨æ–°å®¹å™¨
            echo "Starting containers..."
            if ! \$DOCKER_COMPOSE_CMD -f docker-compose.prod.yml up -d; then
                echo "âŒ Start up failed"
                exit 1
            fi

            # æ¸…ç†æ— ç”¨çš„é•œåƒ
            docker image prune -f

            # 4. éªŒè¯éƒ¨ç½²çŠ¶æ€
            echo "Waiting for container to initialize..."
            sleep 10
            
            # æ£€æŸ¥å®¹å™¨çŠ¶æ€
            \$DOCKER_COMPOSE_CMD -f docker-compose.prod.yml ps
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å®¹å™¨åœ¨è¿è¡Œ
            # è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼šå¦‚æœ ps -q ä¸ºç©ºï¼ˆæ²¡å®¹å™¨ï¼‰ï¼Œæˆ–è€…æœ‰é€€å‡ºçŠ¶æ€çš„å®¹å™¨ï¼Œåˆ™æŠ¥é”™
            RUNNING=\$(\$DOCKER_COMPOSE_CMD -f docker-compose.prod.yml ps --services --filter "status=running")
            if [ -z "\$RUNNING" ]; then
                echo "âŒ Container seems to have exited or failed to start."
                echo "Recent logs:"
                \$DOCKER_COMPOSE_CMD -f docker-compose.prod.yml logs --tail=50
                exit 1
            else
                echo "âœ… Deployment successful! Container is running."
            fi
          EOF

