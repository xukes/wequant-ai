name: Deploy Trading System (Docker)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install sshpass and rsync
        run: sudo apt-get update && sudo apt-get install -y sshpass rsync

      - name: Deploy to Server
        env:
          SSH_HOST: ${{ secrets.ALIYUN_SSH_HOST }}
          SSH_USERNAME: ${{ secrets.ALIYUN_USER_USER }}
          SSH_PASSWORD: ${{ secrets.ALIYUN_SSH_PASSWORD }}
          SSH_PORT: ${{ secrets.ALIYUN_SSH_PORT || '22' }}
          DEPLOY_PATH: ${{ secrets.ALIYUN_DEPLOY_PATH || '/opt/nof1-trading' }}
          # Environment Variables from Secrets
          PORT: ${{ secrets.PORT || 3100 }}
          GATE_API_KEY: ${{ secrets.GATE_API_KEY }}
          GATE_API_SECRET: ${{ secrets.GATE_API_SECRET }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'file:./.voltagent/trading.db' }}
          TRADING_STRATEGY: ${{ secrets.TRADING_STRATEGY || 'balanced' }}
          GATE_USE_TESTNET: ${{ secrets.GATE_USE_TESTNET || 'true' }}
        run: |
          # 1. 同步文件 (排除不需要的文件)
          sshpass -p "$SSH_PASSWORD" rsync -avz --delete \
            -e "ssh -p $SSH_PORT -o StrictHostKeyChecking=no" \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='logs/' \
            --exclude='.env' \
            --exclude='.env.production' \
            --exclude='.voltagent' \
            --exclude='voltagent-data' \
            ./ $SSH_USERNAME@$SSH_HOST:$DEPLOY_PATH/

          # 2. 远程执行部署命令
          sshpass -p "$SSH_PASSWORD" ssh -p $SSH_PORT -o StrictHostKeyChecking=no $SSH_USERNAME@$SSH_HOST << EOF
            cd $DEPLOY_PATH

            # 创建/更新 .env.production 文件 (供 Docker Compose 使用)
            echo "Generating .env.production file..."
            cat > .env.production << ENV_EOF
            PORT=$PORT
            NODE_ENV=production
            GATE_API_KEY=$GATE_API_KEY
            GATE_API_SECRET=$GATE_API_SECRET
            OPENROUTER_API_KEY=$OPENROUTER_API_KEY
            DATABASE_URL=$DATABASE_URL
            TRADING_STRATEGY=$TRADING_STRATEGY
            GATE_USE_TESTNET=$GATE_USE_TESTNET
            # 其他默认配置
            TRADING_INTERVAL_MINUTES=10
            MAX_LEVERAGE=25
            INITIAL_BALANCE=1000
            ENV_EOF
            
            # 为了兼容性，也可以复制一份为 .env（如果脚本里硬编码了读取 .env）
            cp .env.production .env

            # 确保数据目录存在
            mkdir -p voltagent-data logs

            # 检查 Docker 是否安装
            if ! command -v docker &> /dev/null; then
                echo "Error: Docker is not installed on the server."
                exit 1
            fi

            echo "Starting Docker Compose deployment..."
            
            # 停止旧容器并启动新容器
            # --build: 确保重新构建镜像
            # -d: 后台运行
            docker compose -f docker-compose.prod.yml up -d --build --remove-orphans

            # 清理无用的镜像以释放空间
            docker image prune -f

            # 显示状态
            echo "Deployment successful!"
            docker compose -f docker-compose.prod.yml ps
          EOF

