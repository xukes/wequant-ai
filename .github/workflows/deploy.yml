name: Deploy Trading System (Docker)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install sshpass and rsync
        run: sudo apt-get update && sudo apt-get install -y sshpass rsync

      - name: Deploy to Server
        env:
          SSH_HOST: ${{ secrets.ALIYUN_SSH_HOST }}
          SSH_USERNAME: ${{ secrets.ALIYUN_USER_USER }}
          SSH_PASSWORD: ${{ secrets.ALIYUN_SSH_PASSWORD }}
          SSH_PORT: ${{ secrets.ALIYUN_SSH_PORT || '22' }}
          DEPLOY_PATH: ${{ secrets.ALIYUN_DEPLOY_PATH || '/opt/nof1-trading' }}
          # Environment Variables from Secrets
          PORT: ${{ secrets.PORT || 3100 }}
          GATE_API_KEY: ${{ secrets.GATE_API_KEY }}
          GATE_API_SECRET: ${{ secrets.GATE_API_SECRET }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'file:./.voltagent/trading.db' }}
          TRADING_STRATEGY: ${{ secrets.TRADING_STRATEGY || 'balanced' }}
          GATE_USE_TESTNET: ${{ secrets.GATE_USE_TESTNET || 'true' }}
        run: |
          # 1. ÂêåÊ≠•Êñá‰ª∂ (ÊéíÈô§‰∏çÈúÄË¶ÅÁöÑÊñá‰ª∂)
          sshpass -p "$SSH_PASSWORD" rsync -avz --delete \
            -e "ssh -p $SSH_PORT -o StrictHostKeyChecking=no" \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='logs/' \
            --exclude='.env' \
            --exclude='.env.production' \
            --exclude='.voltagent' \
            --exclude='voltagent-data' \
            ./ $SSH_USERNAME@$SSH_HOST:$DEPLOY_PATH/

          # 2. ËøúÁ®ãÊâßË°åÈÉ®ÁΩ≤ÂëΩ‰ª§
          sshpass -p "$SSH_PASSWORD" ssh -p $SSH_PORT -o StrictHostKeyChecking=no $SSH_USERNAME@$SSH_HOST << EOF
            cd $DEPLOY_PATH

            # Ê£ÄÊµãÂèØÁî®ÁöÑ Docker Compose ÂëΩ‰ª§
            DOCKER_COMPOSE_CMD=""
            if docker compose version &> /dev/null; then
                DOCKER_COMPOSE_CMD="docker compose"
            elif command -v docker-compose &> /dev/null; then
                DOCKER_COMPOSE_CMD="docker-compose"
            else
                echo "‚ùå Error: Neither 'docker compose' nor 'docker-compose' found."
                echo "Please install Docker Compose plugin or docker-compose standalone."
                exit 1
            fi
            echo "‚úÖ Using command: \$DOCKER_COMPOSE_CMD"

            # ÂàõÂª∫/Êõ¥Êñ∞ .env.production Êñá‰ª∂ (‰æõ Docker Compose ‰ΩøÁî®)
            echo "Generating .env.production file..."
            cat > .env.production << 'ENV_EOF'
            PORT=${PORT}
            NODE_ENV=production
            GATE_API_KEY=${GATE_API_KEY}
            GATE_API_SECRET=${GATE_API_SECRET}
            OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
            DATABASE_URL=${DATABASE_URL}
            TRADING_STRATEGY=${TRADING_STRATEGY}
            GATE_USE_TESTNET=${GATE_USE_TESTNET}
            # ÂÖ∂‰ªñÈªòËÆ§ÈÖçÁΩÆ
            TRADING_INTERVAL_MINUTES=10
            MAX_LEVERAGE=25
            INITIAL_BALANCE=1000
            ENV_EOF
            
            # ‰∏∫‰∫ÜÂÖºÂÆπÊÄßÔºå‰πüÂèØ‰ª•Â§çÂà∂‰∏Ä‰ªΩ‰∏∫ .envÔºàÂ¶ÇÊûúËÑöÊú¨ÈáåÁ°¨ÁºñÁ†Å‰∫ÜËØªÂèñ .envÔºâ
            cp .env.production .env

            # Á°Æ‰øùÊï∞ÊçÆÁõÆÂΩïÂ≠òÂú®
            mkdir -p voltagent-data logs

            echo "üöÄ Starting Docker Compose deployment..."
            
            # 1. ÊòæÂºèÊûÑÂª∫ÈïúÂÉèÔºåÁ°Æ‰øùÊûÑÂª∫ÊàêÂäü
            echo "Building image..."
            if ! \$DOCKER_COMPOSE_CMD -f docker-compose.prod.yml build; then
                echo "‚ùå build failed"
                exit 1
            fi

            # 2. ÂÅúÊ≠¢Âπ∂ÁßªÈô§ÊóßÂÆπÂô®ÔºàÈò≤Ê≠¢Á´ØÂè£ÂÜ≤Á™ÅÊàñÁä∂ÊÄÅÊÆãÁïôÔºâ
            \$DOCKER_COMPOSE_CMD -f docker-compose.prod.yml down --remove-orphans

            # 3. ÂêØÂä®Êñ∞ÂÆπÂô®
            echo "Starting containers..."
            if ! \$DOCKER_COMPOSE_CMD -f docker-compose.prod.yml up -d; then
                echo "‚ùå Start up failed"
                exit 1
            fi

            # Ê∏ÖÁêÜÊó†Áî®ÁöÑÈïúÂÉè
            docker image prune -f

            # 4. È™åËØÅÈÉ®ÁΩ≤Áä∂ÊÄÅ
            echo "Waiting for container to initialize..."
            sleep 10
            
            # Ê£ÄÊü•ÂÆπÂô®Áä∂ÊÄÅ
            \$DOCKER_COMPOSE_CMD -f docker-compose.prod.yml ps
            
            # Ê£ÄÊü•ÊòØÂê¶ÊúâÂÆπÂô®Âú®ËøêË°å
            # ËøôÈáåÁöÑÈÄªËæëÊòØÔºöÂ¶ÇÊûú ps -q ‰∏∫Á©∫ÔºàÊ≤°ÂÆπÂô®ÔºâÔºåÊàñËÄÖÊúâÈÄÄÂá∫Áä∂ÊÄÅÁöÑÂÆπÂô®ÔºåÂàôÊä•Èîô
            RUNNING=\$(\$DOCKER_COMPOSE_CMD -f docker-compose.prod.yml ps --services --filter "status=running")
            if [ -z "\$RUNNING" ]; then
                echo "‚ùå Container seems to have exited or failed to start."
                echo "Recent logs:"
                \$DOCKER_COMPOSE_CMD -f docker-compose.prod.yml logs --tail=50
                exit 1
            else
                echo "‚úÖ Deployment successful! Container is running."
            fi
          EOF

