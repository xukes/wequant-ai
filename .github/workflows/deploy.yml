name: Deploy Trading System to Remote Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Install sshpass and rsync
        run: sudo apt-get update && sudo apt-get install -y sshpass rsync

      - name: Deploy to remote server
        env:
          SSH_HOST: ${{ secrets.ALIYUN_SSH_HOST }}
          SSH_USERNAME: ${{ secrets.ALIYUN_USER_USER }}
          SSH_PASSWORD: ${{ secrets. ALIYUN_SSH_PASSWORD }}
          SSH_PORT: ${{ secrets.ALIYUN_SSH_PORT || '22' }}
          DEPLOY_PATH: ${{ secrets.ALIYUN_DEPLOY_PATH || '/opt/nof1-trading' }}
        run: |
          # ÂêåÊ≠•‰ª£Á†ÅÂà∞ÊúçÂä°Âô®
          sshpass -p "$SSH_PASSWORD" rsync -avz --delete \
            -e "ssh -p $SSH_PORT -o StrictHostKeyChecking=no" \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.env' \
            --exclude='logs/' \
            --exclude='*.log' \
            ./ $SSH_USERNAME@$SSH_HOST:$DEPLOY_PATH/

      - name: Install dependencies and restart service on server
        env:
          SSH_HOST: ${{ secrets.ALIYUN_SSH_HOST }}
          SSH_USERNAME: ${{ secrets.ALIYUN_USER_USER }}
          SSH_PASSWORD: ${{ secrets.ALIYUN_SSH_PASSWORD }}
          SSH_PORT: ${{ secrets.ALIYUN_SSH_PORT || '22' }}
          DEPLOY_PATH: ${{ secrets.ALIYUN_DEPLOY_PATH || '/opt/nof1-trading' }}
        run: |
          sshpass -p "$SSH_PASSWORD" ssh -p $SSH_PORT -o StrictHostKeyChecking=no $SSH_USERNAME@$SSH_HOST << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            
            # ÂÆâË£Ö‰æùËµñ
            npm ci --production
            
            # ÂÅúÊ≠¢Áé∞ÊúâÊúçÂä°ËøõÁ®ãÔºàÊü•ÊâæÂπ∂ÁªàÊ≠¢Âç†Áî®3100Á´ØÂè£ÁöÑËøõÁ®ãÔºâ
            if lsof -ti:3100; then
              echo "Stopping existing service on port 3100..."
              kill -9 $(lsof -ti:3100) 2>/dev/null || true
            fi
            
            # Á°Æ‰øù.envÊñá‰ª∂Â≠òÂú®Âπ∂ËÆæÁΩÆÁ´ØÂè£
            if [ ! -f .env ]; then
              echo "PORT=3100" > .env
              echo "Warning: Created default .env file with PORT=3100. Please add other required environment variables."
            else
              # Êõ¥Êñ∞ÊàñÊ∑ªÂä†Á´ØÂè£ÈÖçÁΩÆ
              if grep -q "^PORT=" .env; then
                sed -i 's/^PORT=.*/PORT=3100/' .env
              else
                echo "PORT=3100" >> .env
              fi
            fi
            
            # ÂêØÂä®ÊúçÂä°ÔºàÂêéÂè∞ËøêË°åÔºâ
            nohup npm run trading:start > trading.log 2>&1 &
            
            # ËÆ∞ÂΩïÂêØÂä®ÁöÑËøõÁ®ãID
            echo $! > trading.pid
            echo "Trading system started with PID: $(cat trading.pid)"
            
            # Á≠âÂæÖÊúçÂä°ÂêØÂä®
            sleep 5
          EOF

      - name: Health check
        env:
          SSH_HOST: ${{ secrets.ALIYUN_SSH_HOST }}
          SSH_USERNAME: ${{ secrets.ALIYUN_USER_USER }}
          SSH_PASSWORD: ${{ secrets.ALIYUN_SSH_PASSWORD }}
          SSH_PORT: ${{ secrets.ALIYUN_SSH_PORT || '22' }}
        run: |
          # Á≠âÂæÖÊúçÂä°ÂêØÂä®
          sleep 30
          
          # Ê£ÄÊü•ÊúçÂä°ÂÅ•Â∫∑Áä∂ÊÄÅ
          sshpass -p "$SSH_PASSWORD" ssh -p $SSH_PORT -o StrictHostKeyChecking=no $SSH_USERNAME@$SSH_HOST << 'EOF'
            # Ê£ÄÊü•ËøõÁ®ãÊòØÂê¶Â≠òÂú®
            if [ -f trading.pid ]; then
              pid=$(cat trading.pid)
              if ! ps -p "$pid" > /dev/null 2>&1; then
                echo "‚ùå Trading system process is not running"
                echo "Last 20 lines of log:"
                tail -20 trading.log 2>/dev/null || echo "No log file found"
                exit 1
              fi
              echo "‚úÖ Trading system process running (PID: $pid)"
            else
              echo "‚ùå Trading system PID file not found"
              exit 1
            fi
            
            # Ê£ÄÊü•Á´ØÂè£3100ÁõëÂê¨
            if ! netstat -tuln | grep -q ":3100"; then
              echo "‚ùå Application port 3100 is not listening"
              echo "Process may still be starting up. Recent logs:"
              tail -10 trading.log 2>/dev/null || echo "No log file found"
              exit 1
            fi
            
            echo "‚úÖ Trading system deployed and running successfully on port 3100"
            echo "üåê Monitor dashboard: http://localhost:3100/"
            echo "üìä Recent logs:"
            tail -5 trading.log 2>/dev/null || echo "No recent logs"
          EOF

