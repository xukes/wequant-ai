name: Deploy Trading System to Remote Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Install sshpass and rsync
        run: sudo apt-get update && sudo apt-get install -y sshpass rsync

      - name: Deploy to remote server
        env:
          SSH_HOST: ${{ secrets.ALIYUN_SSH_HOST }}
          SSH_USERNAME: ${{ secrets.ALIYUN_USER_USER }}
          SSH_PASSWORD: ${{ secrets. ALIYUN_SSH_PASSWORD }}
          SSH_PORT: ${{ secrets.ALIYUN_SSH_PORT || '22' }}
          DEPLOY_PATH: ${{ secrets.ALIYUN_DEPLOY_PATH || '/opt/nof1-trading' }}
        run: |
          # ÂêåÊ≠•‰ª£Á†ÅÂà∞ÊúçÂä°Âô®
          sshpass -p "$SSH_PASSWORD" rsync -avz --delete \
            -e "ssh -p $SSH_PORT -o StrictHostKeyChecking=no" \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.env' \
            --exclude='logs/' \
            --exclude='*.log' \
            ./ $SSH_USERNAME@$SSH_HOST:$DEPLOY_PATH/

            - name: Install dependencies and restart service on server
        env:
          SSH_HOST: ${{ secrets.ALIYUN_SSH_HOST }}
          SSH_USERNAME: ${{ secrets.ALIYUN_USER_USER }}
          SSH_PASSWORD: ${{ secrets.ALIYUN_SSH_PASSWORD }}
          SSH_PORT: ${{ secrets.ALIYUN_SSH_PORT || '22' }}
          DEPLOY_PATH: ${{ secrets.ALIYUN_DEPLOY_PATH || '/opt/nof1-trading' }}
        run: |
          sshpass -p "$SSH_PASSWORD" ssh -p $SSH_PORT -o StrictHostKeyChecking=no $SSH_USERNAME@$SSH_HOST << EOF
            cd $DEPLOY_PATH
            
            # ÂÅúÊ≠¢Áé∞ÊúâÊúçÂä°ËøõÁ®ãÔºàÂΩªÂ∫ïÊ∏ÖÁêÜÊâÄÊúâÁõ∏ÂÖ≥ËøõÁ®ãÔºâ
            echo "Stopping all related processes..."
            
            # 1. ÂÅúÊ≠¢PM2ËøõÁ®ãÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
            if command -v pm2 &> /dev/null; then
              pm2 stop all 2>/dev/null || true
              pm2 delete all 2>/dev/null || true
            fi
            
            # 2. ÁªàÊ≠¢ÊâÄÊúâÂç†Áî®3100Á´ØÂè£ÁöÑËøõÁ®ã
            if lsof -ti:3100; then
              echo "Killing processes on port 3100..."
              kill -9 \$(lsof -ti:3100) 2>/dev/null || true
            fi
            
            # 3. ÁªàÊ≠¢ÊâÄÊúâÁõ∏ÂÖ≥nodeËøõÁ®ã
            pkill -f "node.*index.js" 2>/dev/null || true
            pkill -f "tsx.*src" 2>/dev/null || true
            pkill -f "npm.*trading" 2>/dev/null || true
            
            # 4. Âà†Èô§ÊóßÁöÑPIDÊñá‰ª∂
            rm -f trading.pid 2>/dev/null || true
            
            # Á≠âÂæÖËøõÁ®ãÂÆåÂÖ®ÈÄÄÂá∫
            sleep 3
            
            # 5. ÂÜçÊ¨°Ê£ÄÊü•Âπ∂Âº∫Âà∂Ê∏ÖÁêÜ
            if lsof -ti:3100; then
              echo "Force killing remaining processes on port 3100..."
              kill -9 \$(lsof -ti:3100) 2>/dev/null || true
              sleep 2
            fi
            
            # ÂÆâË£Ö‰æùËµñ
            npm ci
            
            # ÂÖ®Â±ÄÂÆâË£ÖtsxÔºàÂ¶ÇÊûúÊú™ÂÆâË£ÖÔºâ
            if ! command -v tsx &> /dev/null; then
              echo "Installing tsx globally..."
              npm install -g tsx
            fi
            
            # Á°Æ‰øù.envÊñá‰ª∂Â≠òÂú®Âπ∂ËÆæÁΩÆÁ´ØÂè£
            if [ ! -f .env ]; then
              echo "PORT=3100" > .env
              echo "Warning: Created default .env file with PORT=3100. Please add other required environment variables."
            else
              # Êõ¥Êñ∞ÊàñÊ∑ªÂä†Á´ØÂè£ÈÖçÁΩÆ
              if grep -q "^PORT=" .env; then
                sed -i 's/^PORT=.*/PORT=3100/' .env
              else
                echo "PORT=3100" >> .env
              fi
            fi
            
            # ÂêØÂä®ÊúçÂä°ÔºàÂêéÂè∞ËøêË°åÔºâ
            echo "Starting trading system..."
            nohup npm run trading:start > trading.log 2>&1 &
            
            # ËÆ∞ÂΩïÂêØÂä®ÁöÑËøõÁ®ãID
            trading_pid=\$!
            echo \$trading_pid > trading.pid
            echo "Trading system started with PID: \$trading_pid"
            
            # Á≠âÂæÖÊúçÂä°ÂêØÂä®
            sleep 5
            
            # È™åËØÅËøõÁ®ãÂêØÂä®
            if ps -p \$trading_pid > /dev/null 2>&1; then
              echo "‚úÖ Process \$trading_pid is running"
            else
              echo "‚ùå Process \$trading_pid failed to start"
              echo "Last 10 lines of log:"
              tail -10 trading.log 2>/dev/null || echo "No log file found"
            fi
          EOF

      - name: Health check
        env:
          SSH_HOST: ${{ secrets.ALIYUN_SSH_HOST }}
          SSH_USERNAME: ${{ secrets.ALIYUN_USER_USER }}
          SSH_PASSWORD: ${{ secrets.ALIYUN_SSH_PASSWORD }}
          SSH_PORT: ${{ secrets.ALIYUN_SSH_PORT || '22' }}
          DEPLOY_PATH: ${{ secrets.ALIYUN_DEPLOY_PATH || '/opt/nof1-trading' }}
        run: |
          # Á≠âÂæÖÊúçÂä°ÂêØÂä®
          sleep 30
          
          # Ê£ÄÊü•ÊúçÂä°ÂÅ•Â∫∑Áä∂ÊÄÅ
          sshpass -p "$SSH_PASSWORD" ssh -p $SSH_PORT -o StrictHostKeyChecking=no $SSH_USERNAME@$SSH_HOST << EOF
            cd $DEPLOY_PATH
            
            # Ê£ÄÊü•PIDÊñá‰ª∂ÊòØÂê¶Â≠òÂú®
            if [ ! -f trading.pid ]; then
              echo "‚ùå Trading system PID file not found"
              echo "Current directory: \$(pwd)"
              echo "Files in directory:"
              ls -la | grep -E "(trading|\.pid|\.log)" || echo "No trading related files found"
              exit 1
            fi
            
            # ËØªÂèñPIDÂπ∂Ê£ÄÊü•ËøõÁ®ãÊòØÂê¶Â≠òÂú®
            pid=\$(cat trading.pid)
            if ! ps -p "\$pid" > /dev/null 2>&1; then
              echo "‚ùå Trading system process (PID: \$pid) is not running"
              echo "Last 20 lines of log:"
              tail -20 trading.log 2>/dev/null || echo "No log file found"
              exit 1
            fi
            
            echo "‚úÖ Trading system process running (PID: \$pid)"
            
            # Ê£ÄÊü•Á´ØÂè£3100ÁõëÂê¨
            if ! netstat -tuln | grep -q ":3100"; then
              echo "‚ùå Application port 3100 is not listening"
              echo "Process may still be starting up. Recent logs:"
              tail -10 trading.log 2>/dev/null || echo "No log file found"
              exit 1
            fi
            
            echo "‚úÖ Trading system deployed and running successfully on port 3100"
            echo "üåê Monitor dashboard: http://localhost:3100/"
            echo "üìä Recent logs:"
            tail -5 trading.log 2>/dev/null || echo "No recent logs"
          EOF

