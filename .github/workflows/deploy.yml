name: Deploy Trading System (PM2)

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies (Local)
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Install sshpass and rsync
        run: sudo apt-get update && sudo apt-get install -y sshpass rsync

      - name: Deploy to Server
        env:
          SSH_HOST: ${{ secrets.ALIYUN_SSH_HOST }}
          SSH_USERNAME: ${{ secrets.ALIYUN_USER_USER }}
          SSH_PASSWORD: ${{ secrets.ALIYUN_SSH_PASSWORD }}
          SSH_PORT: ${{ secrets.ALIYUN_SSH_PORT || '22' }}
          DEPLOY_PATH: ${{ secrets.ALIYUN_DEPLOY_PATH || '/opt/nof1-trading' }}
          # Environment Variables from Secrets
          PORT: ${{ secrets.PORT || 3100 }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'file:./.voltagent/trading.db' }}
          TRADING_STRATEGY: ${{ secrets.TRADING_STRATEGY || 'balanced' }}
          GATE_USE_TESTNET: ${{ secrets.GATE_USE_TESTNET || 'true' }}
        run: |
          # 1. 同步文件 (排除不需要的文件)
          sshpass -p "$SSH_PASSWORD" rsync -avz --delete \
            -e "ssh -p $SSH_PORT -o StrictHostKeyChecking=no" \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='logs/' \
            --exclude='.env' \
            --exclude='.voltagent' \
            ./ $SSH_USERNAME@$SSH_HOST:$DEPLOY_PATH/

          # 2. 远程执行部署命令
          sshpass -p "$SSH_PASSWORD" ssh -p $SSH_PORT -o StrictHostKeyChecking=no $SSH_USERNAME@$SSH_HOST << EOF
            cd $DEPLOY_PATH

            # 创建/更新 .env 文件
            echo "Generating .env file..."
            cat > .env << ENV_EOF
            PORT=$PORT
            NODE_ENV=production
            OPENROUTER_API_KEY=$OPENROUTER_API_KEY
            DATABASE_URL=$DATABASE_URL
            TRADING_STRATEGY=$TRADING_STRATEGY
            GATE_USE_TESTNET=$GATE_USE_TESTNET
            # 其他默认配置
            TRADING_INTERVAL_MINUTES=10
            MAX_LEVERAGE=25
            INITIAL_BALANCE=1000
            ENV_EOF

            # 安装生产环境依赖
            npm ci --omit=dev

            # 确保 logs 目录存在
            mkdir -p logs

            # 全局安装 PM2 (如果未安装)
            if ! command -v pm2 &> /dev/null; then
                echo "Installing PM2 globally..."
                npm install -g pm2
            fi

            # 启动或重启应用
            if pm2 list | grep -q "open-nof1.ai"; then
                echo "Reloading application..."
                npm run pm2:restart
            else
                echo "Starting application..."
                npm run pm2:start
            fi

            # 保存当前进程列表，以便服务器重启后自动恢复
            pm2 save
            
            # 显示状态
            echo "Deployment successful!"
            pm2 status open-nof1.ai
          EOF

